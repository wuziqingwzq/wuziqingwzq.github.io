---
layout: post
title:  "树莓派学习（四）：系统备份"
date:   2017-08-15 09:00:00 +0800
categories: RaspberryPi
tags: raspberry raspbian
---
## 为什么需要备份
由于树莓派安装系统使用的是SD卡，并且raspbian系统没有启动修复一说，一旦遇到断电或者一些突发情况，会导致系统中的文件丢失，重装系统虽然也花不了多少时间，但是调整到熟悉的配置却比较麻烦，因此备份你的树莓派是一个好习惯。

## 需要什么环境
由于我工作用的笔记本是Windows，备份和还原都使用了windows系统，但是Windows系统中无法读取到树莓派的Root分区（Etx3类型），用linux可能会是更好的选择。

有如下工具：
* Windows笔记本
* 读卡器
* 装好系统的SD卡

## 如何备份
实际上在Windows下的备份都是简单粗暴的将SD卡的所有内容打包为一个img镜像文件，然后存放在其他储存设备上，以下两种方法可供参考：

## Win32diskimager
win32diskimager这个工具也是写入Raspbian时的工具，在百度上有很多下载链接，界面如下：

![win32diskimager][win32diskimager]

### 系统备份
1. 选择一个img文件，如果没有的话，新建一个xxx.img的空文件
2. 用读卡器连接SD卡，然后选中这张SD卡
3. 点击Read，可以从卡中读取信息到xxx.img文件，如果选错，点击write的话，会将img中的文件覆盖写入到SD卡，就需要重装Raspbian系统了

### 系统还原
1. 选择备份好的img文件
2. 用读卡器连接SD卡，首先对这种卡进行格式化，避免之前的数据对还原有影响
3. 点击Write，就会将系统还原到卡中

### 优缺点
这种备份方法的优点是操作简单，不容易出错，写入速度较快，因为没有进行压缩。但是缺点就是由于是全备份，备份文件大小等于SD卡的容量，如果你的SD卡的是32G的，备份出来的文件也是32G大小，但是你的系统文件可能只有2到3G，光是这一个缺点就让人无法接受了，另外，由于img文件很大，也无法往较小的SD中还原系统，但是如果你的SD卡大小是4G左右，这就是最便捷的备份方式。

## DiskGenius
这个软件在百度上也能找到，但是好像免费版不支持img备份的功能，可能需要下载破解版，操作界面如下图：

![diskgenius][diskgenius]

### 系统备份
1. 用读卡器连接SD卡
2. 打开DiskGenius，会出现SD卡的盘符，如果你已经安装了系统，SD卡下会有两个分区
3. 右键SD卡盘符，选择“备份分区表”，该文件用于还原SD的分区情况
4. 右键SD卡的boot分区（就是较小的那个，约40M，可以被windows识别），选择“备份分区到镜像文件”，保存文件为boot.pmf，这个pmf文件即boot分区，引导开机文件的备份。
5. 右键SD卡的root分区（较大的那个，一般为Ext3格式，只能被lunux识别），选择“备份分区到镜像文件”，保存文件为root.pmf，这个pmf文件即raspbian系统文件的备份。
6. 最后得到四个文件，一个xxx.ptf加上xxx.txt的分区表备份，root.pmf与boot.pmf两个镜像文件。

![备份文件][备份文件]

### 系统还原
1. 用读卡器连接SD卡
2. 打开DiskGenius，右键点击SD卡，选择“删除所有分区”，点击左上角的“保存更改”，会提示格式化该SD卡。
3. 格式化后，右键点击SD卡，选择“还原分区表”，选择之前的备份xxx.ptf。
4. 选择较小的分区，右键点击，选择“从镜像文件还原分区”，选择boot.pmf
5. 选择较大的分区，右键点击，选择“从镜像文件还原分区”，选择root.pmf
6. 安全弹出SD卡，系统还原完成

### 优缺点
使用DiskGenius最大的优点就是在备份分区到镜像的时候，可以选择压缩，这样生成的备份文件只有3G左右，并且可以还原到较小的SD上。缺点就是操作复杂一些，并且会产生多个备份文件。


[win32diskimager]: /assets/pic/2017-08-15/win32diskimager.png
[diskgenius]: /assets/pic/2017-08-15/diskgenius.png
[备份文件]: /assets/pic/2017-08-15/backupfile.jpg